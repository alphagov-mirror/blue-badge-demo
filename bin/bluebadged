#!/usr/bin/env ruby

whirlpool = Gem.loaded_specs['whirlpool']
whirlpoold = File.join File.dirname(whirlpool.loaded_from), whirlpool.bindir, 'whirlpoold'

federation = [
  Process::spawn("ruby #{whirlpoold} ./bb-query-server.config.yml #{ENV['TMPDIR']}"),
  Process::spawn("ruby #{whirlpoold} ./bb-da-pip.config.yml #{ENV['TMPDIR']}"),
  Process::spawn("ruby #{whirlpoold} ./bb-da-dla.config.yml #{ENV['TMPDIR']}"),
  Process::spawn("rackup -p #{ENV['PORT'] || 4567} -o 0.0.0.0 ./bin/config.ru")
]

Signal.trap('INT') do
  STDERR.puts "Bye."
  federation.each {|pid| Process::kill 'INT', pid }
end

Process::waitall
